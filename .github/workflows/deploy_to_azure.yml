name: Deploy to Azure
on:
  push:
    branches: ['main']
    paths:
      - 'terraform/**'
  pull_request:
    branches: ['main']
    paths:
      - 'terraform/**'

permissions:
      id-token: write
      contents: read
jobs: 
  deploy:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v3
        - name: OIDC Login to Azure 
          uses: azure/login@v1
          with:
            client-id: ${{ secrets.CLIENT_ID }}
            tenant-id: ${{ secrets.TENANT_ID }}
            subscription-id: ${{ secrets.SUBSCRIPTION_ID }}
        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v2
          with:
            terraform_version: 1.4.6
        - name: Terraform Deploy
          env:
            TF_VAR_webhook_secret: ${{ secrets.WEBHOOK_SECRET }}
            TF_VAR_private_key: ${{ secrets.PRIVATE_KEY }}
            TF_VAR_app_id: ${{ secrets.APP_ID }}
          working-directory: terraform
          run: terraform init && terraform plan && terraform apply -auto-approve
        - name: Update PowerBI permissions
          shell: pwsh
          env:
            client_id: ${{ secrets.CLIENT_ID }}
            client_secret: ${{ secrets.CLIENT_SECRET }}
            tenant_id: ${{ secrets.TENANT_ID }}
          run: |
            $password = ConvertTo-SecureString $env.client_secret -AsPlainText -Force
            $credential = New-Object System.Management.Automation.PSCredential ($env.client_id, $password)
            Connect-PowerBIServiceAccount -Tenant $env.tenant_id -ServicePrincipal -Credential $credential
